# Node.js with React
# Build a Node.js project that uses React.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master

variables:
- name: npm_cache_directory           
  value: $(Pipeline.Workspace)   # (Build.SourcesDirectory)=(Pipeline.Workspace)
- name: NPM_CACHE_RESTORED           
  value: 'false'
- name: NODE_MODULES_CACHE_RESTORED
  value: 'false'
- name: REACT_APP_VERSION



pool:
  vmImage: ubuntu-latest

stages:
  - stage: BuildArtifact
    jobs:
      - job: BuildArtifact
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: "18.x"
              checkLatest: true
          
          - script: echo 'NODE_MODULES_CACHE_RESTORE = false'
            displayName: 'NODE_MODULES_CACHE_RESTORE value'
            condition: ne(variables.NODE_MODULES_CACHE_RESTORE, 'true')  

          - script: pwd | ls -la
            displayName: 'List files in current working directory'
          
          - task: Cache@2
            displayName: Cache npm
            inputs:
              key: 'npm | "$(Agent.OS)" | $(Build.SourcesDirectory)/package-lock.json'
              path: $(npm_cache_directory)
              restoreKeys: |
                npm | "$(Agent.OS)"
              cacheHitVar: NPM_CACHE_RESTORED

          - task: Cache@2
            displayName: Cache node_modules
            inputs:
              key: 'node_modules | "$(Agent.OS)" | $(Build.SourcesDirectory)/package-lock.json'
              path: '$(Build.SourcesDirectory)/node_modules'
              cacheHitVar: NODE_MODULES_CACHE_RESTORE
    

          - script: echo 'NODE_MODULES_CACHE_RESTORE = true'
            displayName: 'NODE_MODULES_CACHE_RESTORE value'
            condition: eq(variables.NODE_MODULES_CACHE_RESTORE, 'true')      
          
          - script: npm install
            workingDirectory: '$(Build.SourcesDirectory)/'
            displayName: "Install npm packages"
            condition: ne(variables.NODE_MODULES_CACHE_RESTORE, 'true')

          - bash: npm run build
            displayName: Build optimize application

          - script: pwd | ls -la
            displayName: 'List files in current working directory'

          - publish: ./build
            artifact: TestReactBuildArtifact  

          #- script: npmVersionString=$(node -p "require('./package.json').version") && echo "##vso[build.updatebuildnumber]$npmVersionString"
          - script: npmVersionString=$(node -p "require('./package.json').version") && echo "$npmVersionString"
            workingDirectory: '$(Build.SourcesDirectory)/'
            displayName: 'Get application version number'

          - script: echo "$(Build.BuildNumber)" 
            displayName: 'Display Build version'

          - script: |
             npmVersionString=$(node -p "require('./package.json').version") 
             echo "##vso[build.updatebuildnumber]$npmVersionString"
            displayName: 'set build number'  

          # - bash: git checkout $(Build.SourceBranchName)
          #   displayName: 'git checkout' 

          # - bash: git remote add heroku https://heroku:$(heroku_token)@git.heroku.com/powerful-brook-60339.git
          #   displayName: 'git remote add heroku'

          # - bash: git push -f https://heroku:$(heroku_token)@git.heroku.com/powerful-brook-60339.git HEAD
          # # git push heroku -f
          # # $(Build.SourceBranchName)
          #   displayName: 'git push heroku' 